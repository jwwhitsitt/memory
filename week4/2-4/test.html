<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Week 4 (2-4) – Practice Test</title>

  <!-- Kitimus preload -->
  <link rel="preload" as="image" href="/mascots/kitimus/kitimus-neutral.png">
  <link rel="preload" as="image" href="/mascots/kitimus/kitimus-squint.png">
  <link rel="preload" as="image" href="/mascots/kitimus/kitimus-blink.png">
  <link rel="preload" as="image" href="/mascots/kitimus/kitimus-squint-left.png">
  <link rel="preload" as="image" href="/mascots/kitimus/kitimus-squint-right.png">
  <link rel="preload" as="image" href="/mascots/kitimus/kitimus-celebrate.png">

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --shadow:0 10px 30px rgba(15,23,42,.12);
      --radius:18px;
      --link:#1d4ed8;
      --good:#22c55e;
      --bad:#ef4444;
      --btn:#0f172a;
      --btnText:#ffffff;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background:#fff;
      padding:10px 14px;
      box-shadow:0 1px 10px rgba(0,0,0,.06);
      display:flex;
      align-items:center;
      gap:10px;
    }
    header a{
      color:var(--link);
      text-decoration:none;
      font-weight:900;
      white-space:nowrap;
    }
    header h1{
      margin:0;
      font-size:16px;
      font-weight:1000;
      text-align:center;
      flex:1;
    }
    header .spacer{ width:52px; }

    main{
      padding:12px;
      display:flex;
      justify-content:center;
    }
    .wrap{
      width:100%;
      max-width:760px;
    }

    .toprow{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .pill{
      background:#eef2ff;
      color:#28327a;
      font-weight:1000;
      border-radius:999px;
      padding:6px 10px;
      font-size:13px;
      min-width:88px;
      text-align:center;
    }
    .progress{
      height:14px;
      background:#e5e7eb;
      border-radius:999px;
      overflow:hidden;
      position:relative;
    }
    .bar{
      height:100%;
      width:0%;
      background:#c7d2fe;
      transition:width .25s ease;
    }
    .bartext{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:900;
      color:#111827;
    }

    .kitimus{
      width:64px;
      height:64px;
      user-select:none;
      pointer-events:none;
    }
    .kitimus img{
      width:100%;
      height:100%;
      object-fit:contain;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .ref{
      font-weight:1000;
      font-size:18px;
    }
    .prompt{
      font-weight:800;
      line-height:1.4;
    }

    select{
      font-size:16px;
      font-weight:800;
      padding:8px 10px;
      border-radius:10px;
      border:2px solid #e5e7eb;
      margin:0 4px;
    }

    .tiles{
      display:grid;
      grid-template-columns:repeat(6,1fr);
      gap:10px;
    }
    .tile{
      border-radius:14px;
      border:2px solid #e5e7eb;
      padding:14px 0;
      text-align:center;
      font-weight:1000;
      font-size:20px;
      cursor:pointer;
      user-select:none;
      background:#fff;
    }
    .tile.used{
      opacity:.35;
      cursor:not-allowed;
    }

    .slots{
      display:flex;
      gap:6px;
      justify-content:center;
      margin-bottom:8px;
    }
    .slot{
      min-width:22px;
      border-bottom:4px solid #94a3b8;
      text-align:center;
      font-weight:1000;
      font-size:18px;
    }

    .btn{
      margin-top:10px;
      padding:14px;
      border-radius:16px;
      border:0;
      background:var(--btn);
      color:var(--btnText);
      font-weight:1000;
      font-size:16px;
      cursor:pointer;
    }
    .btn.good{ background:var(--good); }
    .btn.bad{ background:var(--bad); }
  </style>
</head>

<body>
<header>
  <a href="./index.html">← Back</a>
  <h1>Practice Test</h1>
  <div class="spacer"></div>
</header>

<main>
  <div class="wrap">

    <div class="toprow">
      <div class="pill" id="modePill">Blanks</div>
      <div class="progress">
        <div class="bar" id="bar"></div>
        <div class="bartext" id="barText"></div>
      </div>
      <div class="kitimus">
        <img id="kitimusImg" src="/mascots/kitimus/kitimus-squint.png" alt="">
      </div>
    </div>

    <section class="card" id="card"></section>

  </div>
</main>

<script>
/* ============================
   DATA (LOCKED, CLEAN)
============================ */

const JOHN_OPTIONS = ["choose","chose","appointed","anointed"]; // decoy included

const QUESTIONS = [
  // Blanks – John 15:16 (3 blanks, 3 dropdowns)
  {
    mode:"blanks",
    ref:"John 15:16",
    text:"You did not ___ me, but I ___ you and ___ you.",
    blanks:[
      { answer:"choose", options: JOHN_OPTIONS },
      { answer:"chose", options: JOHN_OPTIONS },
      { answer:"appointed", options: JOHN_OPTIONS }
    ]
  },

  // Blanks – Romans 10:17 (2 blanks, 2 dropdowns)
  {
    mode:"blanks",
    ref:"Romans 10:17",
    text:"So faith comes from ___, and ___ through the word of Christ.",
    blanks:[
      { answer:"hearing", options:["hearing","reading","learning","speaking"] },
      { answer:"hearing", options:["hearing","reading","learning","speaking"] }
    ]
  },

  // Spelling tiles – significant words only (6 total)
  { mode:"tiles", ref:"John 15:16",   context:"You did not ___ me, but I chose you.",                      answer:"choose" },
  { mode:"tiles", ref:"John 15:16",   context:"You did not choose me, but I ___ you.",                    answer:"chose" },
  { mode:"tiles", ref:"John 15:16",   context:"You did not choose me, but I chose you and ___ you.",      answer:"appointed" },

  { mode:"tiles", ref:"Romans 10:17", context:"So ___ comes from hearing, and hearing through the word of Christ.", answer:"faith" },
  { mode:"tiles", ref:"Romans 10:17", context:"So faith comes from ___, and hearing through the word of Christ.", answer:"hearing" },
  { mode:"tiles", ref:"Romans 10:17", context:"So faith comes from hearing, and hearing through the word of ___.", answer:"Christ" }
];

/* ============================
   ENGINE
============================ */

let idx = 0;
const card = document.getElementById("card");
const bar = document.getElementById("bar");
const barText = document.getElementById("barText");
const pill = document.getElementById("modePill");

function updateProgress(){
  bar.style.width = `${Math.round(((idx+1)/QUESTIONS.length)*100)}%`;
  barText.textContent = `${idx+1} of ${QUESTIONS.length}`;
}

function shuffle(a){
  const x = a.slice();
  for(let i=x.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [x[i],x[j]]=[x[j],x[i]];
  }
  return x;
}

function normalizeWord(w){
  return (w || "").toString().trim();
}

function buildLetterTiles(answer){
  // answer can include mixed case. tiles are uppercase.
  const target = normalizeWord(answer);
  const targetLetters = target.toUpperCase().split("");

  // Decoy letters: add 2 letters not already overrepresented
  const ALPHA = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
  const existing = new Set(targetLetters);
  const decoys = [];

  while(decoys.length < 2){
    const pick = ALPHA[Math.floor(Math.random()*ALPHA.length)];
    // allow repeats only if needed, but try to avoid duplicates
    if(decoys.includes(pick)) continue;
    // prefer letters not in the word, but allow if the word is short
    if(existing.has(pick) && targetLetters.length > 5) continue;
    decoys.push(pick);
  }

  // Shuffle tiles
  const tiles = shuffle(targetLetters.concat(decoys));
  return { target, targetLetters, tiles };
}

function render(){
  updateProgress();
  card.innerHTML = "";

  const q = QUESTIONS[idx];
  pill.textContent = q.mode === "blanks" ? "Blanks" : "Spelling";

  if(q.mode === "blanks"){
    card.innerHTML = `<div class="ref">${q.ref}</div>`;

    const p = document.createElement("div");
    p.className = "prompt";

    // IMPORTANT: replace ALL blanks, not just the first one
    let blankIndex = 0;
    p.innerHTML = q.text.replace(/___/g, () => {
      const b = q.blanks[blankIndex++];
      if(!b){
        // Safety: if text has more blanks than data, show a literal blank.
        return "___";
      }
      const opts = (b.options || []).slice(0,4);
      const html = `
        <select data-answer="${b.answer}">
          <option value="">---</option>
          ${opts.map(o => `<option value="${o}">${o}</option>`).join("")}
        </select>
      `;
      return html;
    });

    card.appendChild(p);

    const btn = document.createElement("button");
    btn.className = "btn";
    btn.textContent = "Check";

    btn.onclick = () => {
      const selects = card.querySelectorAll("select");
      let ok = true;

      selects.forEach(s => {
        if(s.value !== s.dataset.answer) ok = false;
      });

      btn.classList.remove("good","bad");
      btn.classList.add(ok ? "good" : "bad");
      setTimeout(next, 600);
    };

    card.appendChild(btn);
    return;
  }

  if(q.mode === "tiles"){
    card.innerHTML = `<div class="ref">${q.ref}</div>
      <div class="prompt">${q.context}</div>`;

    const { target, targetLetters, tiles } = buildLetterTiles(q.answer);

    // Slots
    const slots = document.createElement("div");
    slots.className = "slots";

    const slotEls = targetLetters.map(() => {
      const s = document.createElement("div");
      s.className = "slot";
      slots.appendChild(s);
      return s;
    });

    card.appendChild(slots);

    // Tiles grid
    const grid = document.createElement("div");
    grid.className = "tiles";

    // Track clicks for backspace
    const stack = []; // { tileEl, slotIndex }

    tiles.forEach(l => {
      const t = document.createElement("div");
      t.className = "tile";
      t.textContent = l;

      t.onclick = () => {
        if(t.classList.contains("used")) return;

        const slotIndex = slotEls.findIndex(el => el.textContent === "");
        if(slotIndex === -1) return;

        slotEls[slotIndex].textContent = l;
        t.classList.add("used");
        stack.push({ tileEl: t, slotIndex });
      };

      grid.appendChild(t);
    });

    card.appendChild(grid);

    // Bottom controls
    const controls = document.createElement("div");
    controls.className = "bottom";

    const backBtn = document.createElement("button");
    backBtn.className = "btn secondary";
    backBtn.textContent = "Backspace";
    backBtn.onclick = () => {
      const last = stack.pop();
      if(!last) return;

      slotEls[last.slotIndex].textContent = "";
      last.tileEl.classList.remove("used");
    };

    const clearBtn = document.createElement("button");
    clearBtn.className = "btn secondary";
    clearBtn.textContent = "Clear";
    clearBtn.onclick = () => {
      // Clear slots
      slotEls.forEach(el => el.textContent = "");
      // Unuse tiles
      grid.querySelectorAll(".tile.used").forEach(el => el.classList.remove("used"));
      // Clear stack
      stack.length = 0;
    };

    const checkBtn = document.createElement("button");
    checkBtn.className = "btn";
    checkBtn.textContent = "Check";
    checkBtn.onclick = () => {
      const attempt = slotEls.map(el => el.textContent).join("");
      const ok = attempt === target.toUpperCase();

      checkBtn.classList.remove("good","bad");
      checkBtn.classList.add(ok ? "good" : "bad");

      setTimeout(next, 600);
    };

    controls.appendChild(backBtn);
    controls.appendChild(clearBtn);
    controls.appendChild(checkBtn);

    card.appendChild(controls);
    return;
  }

  // Safety if a question has an invalid mode
  card.innerHTML = `<div class="ref">Data error</div>
    <div class="prompt">Invalid question mode at ${idx+1}. Fix the QUESTIONS array.</div>`;
}

function next(){
  if(idx < QUESTIONS.length - 1){
    idx++;
    render();
  } else {
    card.innerHTML = "<h2>Nice work.</h2>";
    bar.style.width = "100%";
    barText.textContent = `${QUESTIONS.length} of ${QUESTIONS.length}`;
  }
}

render();
</script>
</body>
</html>
